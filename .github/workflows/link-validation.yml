name: Link Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'vibe-ensemble-web/**'
      - 'vibe-ensemble-server/**'
      - '.github/workflows/link-validation.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'vibe-ensemble-web/**'
      - 'vibe-ensemble-server/**'
      - '.github/workflows/link-validation.yml'
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      base_url:
        description: 'Base URL to validate against'
        required: false
        default: 'http://127.0.0.1:8081'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  link-validation:
    name: Validate Navigation Links
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Build and start server
      run: |
        set -euo pipefail
        # Ensure dependencies
        sudo apt-get update && sudo apt-get install -y bc jq
        # Build only the server binary we need
        cargo build --bin vibe-ensemble --release

        # Start server with SQLite (default) in background
        ./target/release/vibe-ensemble --port=8081 &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> "$GITHUB_ENV"

        # Wait for server to be ready (max 30 seconds)
        for i in {1..30}; do
          if curl -fsS "http://127.0.0.1:8081/api/health" >/dev/null 2>&1; then
            echo "‚úÖ Server is ready"
            break
          fi
          echo "‚è≥ Waiting for server... ($i/30)"
          sleep 1
        done

        # Verify server is running
        curl -fsS "http://127.0.0.1:8081/api/health" || (echo "‚ùå Server failed to start" && exit 1)

    - name: Run link validation tests
      env:
        BASE_URL: ${{ github.event.inputs.base_url || 'http://127.0.0.1:8081' }}
      run: |
        echo "üîç Testing navigation endpoints..."

        # Dashboard pages
        curl -f "$BASE_URL"/ || echo "‚ùå FAIL: Root dashboard"
        curl -f "$BASE_URL"/dashboard || echo "‚ùå FAIL: Dashboard page"
        curl -f "$BASE_URL"/link-health || echo "‚ùå FAIL: Link health page"
        curl -f "$BASE_URL"/messages || echo "‚ùå FAIL: Messages page"

        # API endpoints
        echo "üîç Testing API endpoints..."
        curl -f "$BASE_URL"/api/health || echo "‚ùå FAIL: Health API"
        curl -f "$BASE_URL"/api/stats || echo "‚ùå FAIL: Stats API"
        curl -f "$BASE_URL"/api/agents || echo "‚ùå FAIL: Agents API"
        curl -f "$BASE_URL"/api/issues || echo "‚ùå FAIL: Issues API"
        curl -f "$BASE_URL"/api/messages || echo "‚ùå FAIL: Messages API"

        # Link validation API endpoints
        echo "üîç Testing link validation APIs..."
        curl -f "$BASE_URL"/api/links/health || echo "‚ùå FAIL: Link health API"
        curl -f "$BASE_URL"/api/links/status || echo "‚ùå FAIL: Link status API"
        curl -f "$BASE_URL"/api/links/analytics || echo "‚ùå FAIL: Link analytics API"

        echo "‚úÖ Navigation tests completed"

    - name: Run automated link validation
      env:
        BASE_URL: ${{ github.event.inputs.base_url || 'http://127.0.0.1:8081' }}
      run: |
        echo "üîç Running automated link validation..."

        # Trigger full link validation
        response="$(curl -s "$BASE_URL"/api/links/validate)"
        echo "Validation response: $response"

        # Check validation results
        health_response="$(curl -s "$BASE_URL"/api/links/health)"
        echo "Health summary: $health_response"

        # Extract health score and validate it's above threshold
        health_score="$(echo "$health_response" | jq -r '.health_score // 0')"
        echo "üìä Current health score: $health_score%"

        # Fail if health score is below 80%
        if (( $(echo "$health_score < 80" | bc -l) )); then
          echo "‚ùå ERROR: Link health score ($health_score%) is below threshold (80%)"
          echo "üîß Broken links detected - check link validation report"
          exit 1
        else
          echo "‚úÖ SUCCESS: Link health score ($health_score%) meets threshold"
        fi

    - name: Generate link validation report
      if: always()
      env:
        BASE_URL: ${{ github.event.inputs.base_url || 'http://127.0.0.1:8081' }}
      run: |
        echo "üìã Generating link validation report..."

        # Get detailed reports
        curl -s "$BASE_URL"/api/links/status | jq '.' > "link-status-report.json" || echo "{}" > "link-status-report.json"
        curl -s "$BASE_URL"/api/links/health | jq '.' > "link-health-summary.json" || echo "{}" > "link-health-summary.json"
        curl -s "$BASE_URL"/api/links/analytics | jq '.' > "link-analytics-report.json" || echo "{}" > "link-analytics-report.json"

        # Display summary
        echo "=== üìä LINK VALIDATION SUMMARY ==="
        echo "Health Score: $(jq -r '.health_score // 0' "link-health-summary.json")%"
        echo "Total Links: $(jq -r '.total_links // 0' "link-health-summary.json")"
        echo "Healthy Links: $(jq -r '.healthy_links // 0' "link-health-summary.json")"
        echo "Broken Links: $(jq -r '.broken_links // 0' "link-health-summary.json")"
        echo "Warning Links: $(jq -r '.warning_links // 0' "link-health-summary.json")"

    - name: Upload link validation reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: link-validation-reports
        path: |
          link-*.json
        retention-days: 30

    - name: Comment on PR with link validation results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      env:
        BASE_URL: ${{ github.event.inputs.base_url || 'http://127.0.0.1:8081' }}
      with:
        script: |
          const fs = require('fs');

          // Read health summary
          let healthSummary = {};
          try {
            healthSummary = JSON.parse(fs.readFileSync('link-health-summary.json', 'utf8'));
          } catch (e) {
            console.log('Could not read health summary');
          }

          const healthScore = healthSummary.health_score || 0;
          const totalLinks = healthSummary.total_links || 0;
          const brokenLinks = healthSummary.broken_links || 0;
          const healthyLinks = healthSummary.healthy_links || 0;
          const warningLinks = healthSummary.warning_links || 0;

          const status = healthScore >= 95 ? 'üü¢' :
                        healthScore >= 80 ? 'üü°' : 'üî¥';

          const comment = `## Link Validation Results ${status}

          **Health Score: ${healthScore.toFixed(1)}%**

          | Metric | Count |
          |--------|-------|
          | Total Links | ${totalLinks} |
          | üü¢ Healthy | ${healthyLinks} |
          | üü° Warnings | ${warningLinks} |
          | üî¥ Broken | ${brokenLinks} |

          ${brokenLinks > 0 ?
            '‚ö†Ô∏è **Action Required**: Some links are broken and need attention.' :
            '‚úÖ All navigation links are healthy!'}

          <details>
          <summary>View detailed results</summary>

          Check the [link validation reports](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for full details.
          </details>`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Cleanup
      if: always()
      run: |
        # Kill the background server if it's still running
        if [ -n "${SERVER_PID:-}" ]; then
          kill "$SERVER_PID" || true
        fi
