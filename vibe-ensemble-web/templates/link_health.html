{% extends "base.html" %}

{% block title %}Link Health Monitoring - Vibe Ensemble{% endblock %}
{% block page_title %}Link Health Monitoring{% endblock %}
{% block page_description %}Navigation integrity and link validation dashboard{% endblock %}

{% block extra_head %}
<style>
    /* Link Health Specific Styles */
    .health-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .health-stat {
        background: var(--white);
        padding: 20px;
        border-radius: var(--border-radius);
        text-align: center;
        box-shadow: var(--box-shadow);
        border-left: 4px solid;
    }

    .health-stat.healthy { border-left-color: var(--success-color); }
    .health-stat.warning { border-left-color: var(--warning-color); }
    .health-stat.broken { border-left-color: var(--danger-color); }
    .health-stat.unknown { border-left-color: var(--secondary-color); }

    .health-number {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .health-label {
        font-size: 0.875rem;
        color: var(--gray-600);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .health-score {
        font-size: 3rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .health-score.excellent { color: var(--success-color); }
    .health-score.good { color: var(--success-color); }
    .health-score.fair { color: var(--warning-color); }
    .health-score.poor { color: var(--danger-color); }

    .link-table {
        background: var(--white);
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--box-shadow);
    }

    .link-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 150px 100px 120px;
        padding: 15px 20px;
        border-bottom: 1px solid var(--gray-200);
        align-items: center;
        transition: background-color 0.2s;
    }

    .link-row:hover {
        background-color: var(--gray-50);
    }

    .link-row.header {
        background-color: var(--gray-100);
        font-weight: 600;
        border-bottom: 2px solid var(--gray-300);
    }

    .link-url {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.875rem;
    }

    .link-status {
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
    }

    .status-indicator.healthy { background-color: var(--success-color); }
    .status-indicator.warning { background-color: var(--warning-color); }
    .status-indicator.broken { background-color: var(--danger-color); }
    .status-indicator.unknown { background-color: var(--secondary-color); }

    .response-time {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.875rem;
        color: var(--gray-600);
    }

    .success-rate {
        font-weight: 600;
    }

    .success-rate.excellent { color: var(--success-color); }
    .success-rate.good { color: var(--success-color); }
    .success-rate.fair { color: var(--warning-color); }
    .success-rate.poor { color: var(--danger-color); }

    .link-actions {
        display: flex;
        gap: 5px;
    }

    .btn-icon {
        padding: 5px 8px;
        font-size: 0.75rem;
        min-width: auto;
    }

    .filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        align-items: center;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .filter-group label {
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 0;
    }

    .filter-group select {
        padding: 5px 10px;
        font-size: 0.875rem;
        border-radius: var(--border-radius);
        border: 1px solid var(--gray-400);
    }

    .auto-refresh {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: auto;
    }

    .refresh-indicator {
        color: var(--success-color);
        font-size: 0.875rem;
    }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        border-radius: var(--border-radius);
    }

    .link-container {
        position: relative;
    }

    .analytics-card {
        background: var(--white);
        padding: 20px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        margin-bottom: 20px;
    }

    .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .chart-container {
        height: 200px;
        background: var(--gray-50);
        border-radius: var(--border-radius);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--gray-500);
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<div class="health-overview" id="healthOverview">
    <div class="health-stat" id="totalLinks">
        <div class="health-number">0</div>
        <div class="health-label">Total Links</div>
    </div>
    <div class="health-stat healthy" id="healthyLinks">
        <div class="health-number">0</div>
        <div class="health-label">Healthy</div>
    </div>
    <div class="health-stat warning" id="warningLinks">
        <div class="health-number">0</div>
        <div class="health-label">Warnings</div>
    </div>
    <div class="health-stat broken" id="brokenLinks">
        <div class="health-number">0</div>
        <div class="health-label">Broken</div>
    </div>
    <div class="health-stat" id="healthScore">
        <div class="health-score" id="scoreValue">100%</div>
        <div class="health-label">Health Score</div>
    </div>
    <div class="health-stat" id="avgResponseTime">
        <div class="health-number">0ms</div>
        <div class="health-label">Avg Response</div>
    </div>
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>Link Status Monitor</h2>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="validateAllLinks()">
                <span class="spinner" id="validateSpinner" style="display: none;"></span>
                Validate All Links
            </button>
            <button class="btn btn-secondary" onclick="refreshStatus()">Refresh</button>
        </div>
    </div>

    <div class="filters">
        <div class="filter-group">
            <label for="typeFilter">Type:</label>
            <select id="typeFilter" onchange="applyFilters()">
                <option value="">All Types</option>
                <option value="navigation">Navigation</option>
                <option value="api">API</option>
                <option value="websocket">WebSocket</option>
                <option value="external">External</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="statusFilter">Status:</label>
            <select id="statusFilter" onchange="applyFilters()">
                <option value="">All Status</option>
                <option value="healthy">Healthy</option>
                <option value="warning">Warning</option>
                <option value="broken">Broken</option>
                <option value="unknown">Unknown</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="successRateFilter">Min Success Rate:</label>
            <select id="successRateFilter" onchange="applyFilters()">
                <option value="">Any Rate</option>
                <option value="0.9">90%+</option>
                <option value="0.7">70%+</option>
                <option value="0.5">50%+</option>
            </select>
        </div>
        <div class="auto-refresh">
            <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
            <label for="autoRefresh">Auto Refresh (30s)</label>
            <span class="refresh-indicator" id="refreshIndicator" style="display: none;">●</span>
        </div>
    </div>

    <div class="link-container">
        <div class="loading-overlay" id="loadingOverlay">
            <div>
                <div class="spinner"></div>
                Loading link status...
            </div>
        </div>
        
        <div class="link-table">
            <div class="link-row header">
                <div>URL</div>
                <div>Type</div>
                <div>Status</div>
                <div>Response Time</div>
                <div>Success Rate</div>
                <div>Actions</div>
            </div>
            <div id="linkTableBody">
                <!-- Links will be populated here -->
            </div>
        </div>
    </div>
</div>

<div class="analytics-grid">
    <div class="analytics-card">
        <h3>Response Time Trends</h3>
        <div class="chart-container">
            Response time chart placeholder
        </div>
    </div>
    <div class="analytics-card">
        <h3>Link Status Distribution</h3>
        <div class="chart-container">
            Status distribution chart placeholder
        </div>
    </div>
</div>

<div class="card">
    <h3>Recent Navigation Activity</h3>
    <div id="navigationAnalytics">
        <!-- Navigation analytics will be populated here -->
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
let autoRefreshInterval = null;
let allLinks = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadLinkStatus();
    loadHealthSummary();
    loadNavigationAnalytics();
});

// Load link status from API
async function loadLinkStatus() {
    try {
        showLoading(true);
        const response = await fetch('/api/links/status');
        const data = await response.json();
        
        allLinks = data.links || [];
        displayLinks(allLinks);
        showLoading(false);
    } catch (error) {
        console.error('Failed to load link status:', error);
        showError('Failed to load link status');
        showLoading(false);
    }
}

// Load health summary
async function loadHealthSummary() {
    try {
        const response = await fetch('/api/links/health');
        const summary = await response.json();
        
        updateHealthOverview(summary);
    } catch (error) {
        console.error('Failed to load health summary:', error);
    }
}

// Load navigation analytics
async function loadNavigationAnalytics() {
    try {
        const response = await fetch('/api/links/analytics');
        const data = await response.json();
        
        displayNavigationAnalytics(data.analytics || []);
    } catch (error) {
        console.error('Failed to load analytics:', error);
    }
}

// Update health overview display
function updateHealthOverview(summary) {
    document.getElementById('totalLinks').querySelector('.health-number').textContent = summary.total_links || 0;
    document.getElementById('healthyLinks').querySelector('.health-number').textContent = summary.healthy_links || 0;
    document.getElementById('warningLinks').querySelector('.health-number').textContent = summary.warning_links || 0;
    document.getElementById('brokenLinks').querySelector('.health-number').textContent = summary.broken_links || 0;
    
    const score = Math.round(summary.health_score || 100);
    const scoreElement = document.getElementById('scoreValue');
    scoreElement.textContent = score + '%';
    
    // Set score color based on value
    scoreElement.className = 'health-score';
    if (score >= 95) scoreElement.classList.add('excellent');
    else if (score >= 80) scoreElement.classList.add('good');
    else if (score >= 60) scoreElement.classList.add('fair');
    else scoreElement.classList.add('poor');
    
    // Average response time
    const avgTime = summary.average_response_time 
        ? Math.round(summary.average_response_time.secs * 1000 + summary.average_response_time.nanos / 1000000)
        : 0;
    document.getElementById('avgResponseTime').querySelector('.health-number').textContent = avgTime + 'ms';
}

// Display links in table
function displayLinks(links) {
    const tbody = document.getElementById('linkTableBody');
    tbody.innerHTML = '';
    
    if (links.length === 0) {
        tbody.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--gray-500);">No links found</div>';
        return;
    }
    
    links.forEach(link => {
        const row = createLinkRow(link);
        tbody.appendChild(row);
    });
}

// Create table row for link
function createLinkRow(link) {
    const row = document.createElement('div');
    row.className = 'link-row';
    
    const responseTime = link.response_time 
        ? Math.round(link.response_time.secs * 1000 + link.response_time.nanos / 1000000) + 'ms'
        : 'N/A';
    
    const successRate = Math.round((link.success_rate || 0) * 100);
    let successRateClass = 'success-rate ';
    if (successRate >= 95) successRateClass += 'excellent';
    else if (successRate >= 80) successRateClass += 'good';
    else if (successRate >= 60) successRateClass += 'fair';
    else successRateClass += 'poor';
    
    row.innerHTML = `
        <div class="link-url">${link.url}</div>
        <div>${link.link_type}</div>
        <div class="link-status">
            <span class="status-indicator ${link.status.toLowerCase()}"></span>
            ${link.status}
        </div>
        <div class="response-time">${responseTime}</div>
        <div class="${successRateClass}">${successRate}%</div>
        <div class="link-actions">
            <button class="btn btn-sm btn-primary btn-icon" onclick="validateSingleLink('${link.url}')" title="Validate">
                ✓
            </button>
            <button class="btn btn-sm btn-secondary btn-icon" onclick="viewLinkDetails('${link.url}')" title="Details">
                ⓘ
            </button>
        </div>
    `;
    
    return row;
}

// Validate all links
async function validateAllLinks() {
    const spinner = document.getElementById('validateSpinner');
    spinner.style.display = 'inline-block';
    
    try {
        const response = await fetch('/api/links/validate', { method: 'GET' });
        const data = await response.json();
        
        if (data.status === 'completed') {
            await loadLinkStatus();
            await loadHealthSummary();
            showSuccess('Link validation completed');
        } else {
            showError('Validation failed: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Validation failed:', error);
        showError('Failed to validate links');
    } finally {
        spinner.style.display = 'none';
    }
}

// Validate single link
async function validateSingleLink(url) {
    try {
        const encodedUrl = encodeURIComponent(url);
        const response = await fetch(`/api/links/${encodedUrl}/validate`);
        const data = await response.json();
        
        if (data.result) {
            // Update the specific link in the display
            const linkIndex = allLinks.findIndex(link => link.url === url);
            if (linkIndex !== -1) {
                allLinks[linkIndex] = data.result;
                displayLinks(applyCurrentFilters(allLinks));
            }
            showSuccess(`Validated: ${url}`);
        }
    } catch (error) {
        console.error('Single link validation failed:', error);
        showError(`Failed to validate: ${url}`);
    }
}

// View link details (placeholder)
function viewLinkDetails(url) {
    const link = allLinks.find(l => l.url === url);
    if (link) {
        alert(`Link Details:\n\nURL: ${link.url}\nType: ${link.link_type}\nStatus: ${link.status}\nLast Checked: ${link.last_checked}\nCheck Count: ${link.check_count}\nError: ${link.error_message || 'None'}`);
    }
}

// Apply filters
function applyFilters() {
    const filteredLinks = applyCurrentFilters(allLinks);
    displayLinks(filteredLinks);
}

// Apply current filter settings
function applyCurrentFilters(links) {
    const typeFilter = document.getElementById('typeFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const successRateFilter = parseFloat(document.getElementById('successRateFilter').value) || 0;
    
    return links.filter(link => {
        if (typeFilter && link.link_type.toLowerCase() !== typeFilter) return false;
        if (statusFilter && link.status.toLowerCase() !== statusFilter) return false;
        if (successRateFilter > 0 && link.success_rate < successRateFilter) return false;
        return true;
    });
}

// Refresh status
function refreshStatus() {
    loadLinkStatus();
    loadHealthSummary();
    loadNavigationAnalytics();
}

// Toggle auto refresh
function toggleAutoRefresh() {
    const checkbox = document.getElementById('autoRefresh');
    const indicator = document.getElementById('refreshIndicator');
    
    if (checkbox.checked) {
        autoRefreshInterval = setInterval(refreshStatus, 30000);
        indicator.style.display = 'inline';
    } else {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
        indicator.style.display = 'none';
    }
}

// Display navigation analytics
function displayNavigationAnalytics(analytics) {
    const container = document.getElementById('navigationAnalytics');
    
    if (analytics.length === 0) {
        container.innerHTML = '<p style="color: var(--gray-500); text-align: center;">No navigation data available</p>';
        return;
    }
    
    const analyticsHTML = analytics.map(item => `
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; padding: 10px 0; border-bottom: 1px solid var(--gray-200);">
            <div>${item.path}</div>
            <div>${item.visit_count} visits</div>
            <div>${item.error_count} errors</div>
            <div>${new Date(item.last_visit).toLocaleString()}</div>
        </div>
    `).join('');
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; padding: 10px 0; border-bottom: 2px solid var(--gray-300); font-weight: 600; background: var(--gray-100);">
            <div>Path</div>
            <div>Visits</div>
            <div>Errors</div>
            <div>Last Visit</div>
        </div>
        ${analyticsHTML}
    `;
}

// Utility functions
function showLoading(show) {
    document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
}

function showSuccess(message) {
    // Simple alert for now - could be enhanced with toast notifications
    console.log('Success:', message);
}

function showError(message) {
    // Simple alert for now - could be enhanced with toast notifications
    console.error('Error:', message);
    alert('Error: ' + message);
}
</script>
{% endblock %}